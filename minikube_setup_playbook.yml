---
- hosts: all
  become: true
  tasks:
  - name: Update apt-get repo and cache
    apt: update_cache=yes force_apt_get=yes cache_valid_time=3600

  - name: Upgrade all apt packages
    apt: upgrade=dist force_apt_get=yes

  - name: Install packages that allow apt to be used over HTTPS
    apt:
      name: "{{ packages }}"
      state: present
      update_cache: yes
      force_apt_get: yes
    vars:
      packages:
        - apt-transport-https

  - name: Install docker and its dependecies
    apt:
      name: "{{ packages }}"
      state: present
      update_cache: yes
      install_recommends: yes
    vars:
      packages:
      - docker.io

  - name: Add vagrant user to docker group
    user:
      name: vagrant
      group: docker

  - name: Start docker
    command: systemctl enable --now docker

  - name: Unconditionally reboot the machine with all defaults
    reboot:

  - name: download Minikube
    get_url: url=https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64 dest=.

  - name: Copy Minikube and set permissions
    copy:
      src: minikube-linux-amd64
      dest: /usr/local/bin/minikube
      remote_src: yes
      mode: +x

  - name: download Kubectl
    get_url: url=https://storage.googleapis.com/kubernetes-release/release/v1.19.0/bin/linux/amd64/kubectl dest=.

  - name: Copy Kubectl and set permissions
    copy:
      src: kubectl
      remote_src: yes
      dest: /usr/local/bin/kubectl
      mode: +x

  - name: StartKube
    become: false
    command: minikube start --cpus 2 --memory 2048

  - name: Check nodes
    become: false
    command: kubectl get nodes
    register: kubectl_nodes

  - name: Create service account
    become: false
    command: kubectl create serviceaccount serviceman --namespace kube-system

  - name: Bind account
    become: false
    command: kubectl create clusterrolebinding serviceman-role-binding --clusterrole cluster-admin --serviceaccount=kube-system:serviceman
  
  - name: Download Helm
    get_url:
      url: https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
      dest: ./get_helm.sh
      mode: '700'
  
  - name: Install helm
    command: ./get_helm.sh
  
  - name: Init helm
    become: false
    command: helm init --service-account serviceman
  
  - name: Update helm repos
    become: false
    command: helm repo up
  
  - debug: msg="{{ kubectl_nodes.stdout }}"